<?xml version="1.0"?>
<robot xmlns:xacro="http://www.ros.org/wiki/xacro" name="magneto">

<!-- Name of robot used to find config and description files -->
<xacro:property name="robot_config" value="magneto_2" />

<!-- Load robot configuration parameters from YAML file -->
<xacro:property name="robot_params_filename" value="$(find ${robot_config}_description)/config/${robot_config}.yaml" />
<xacro:property name="robot_params" value="${load_yaml(robot_params_filename)['syropod']['parameters']}"/>

<!-- Load link configuration parameters from YAML file -->
<xacro:property name="link_params_filename" value="$(find ${robot_config}_description)/config/${robot_config}_link_configs.yaml" />
<xacro:property name="link_params" value="${load_yaml(link_params_filename)[robot_config]}"/>

  <link name="base_link">
    <inertial>
      <origin rpy="0 0 0" xyz="-0.2696E-03 0 33.3181E-03"/>
      <mass value="1.44521"/>
      <inertia ixx="0.0083421056972" ixy="-4.932e-08" ixz="-2.47500871e-05" iyy="0.0136724752281" iyz="2.37e-11" izz="0.0180888568473"/>
    </inertial>
    <visual>
      <geometry>
        <mesh filename="package://magneto_2_description/meshes/base_link.STL"/>
      </geometry>
      <origin rpy="0 0 0" xyz="0 0 0"/>
      <material name="black"/>
    </visual>
    <collision>
      <geometry>
        <mesh filename="package://magneto_2_description/meshes/base_link_collision.STL"/>
      </geometry>
      <origin rpy="0 0 0" xyz="0 0 0"/>
    </collision>
  </link>
  
<xacro:macro name="setup_inertia" params="link_name link_config">
  <inertial>
      <origin 
      xyz="${link_params[link_name][link_config]['inertial']['origin']['x']}
           ${link_params[link_name][link_config]['inertial']['origin']['y']}
           ${link_params[link_name][link_config]['inertial']['origin']['z']}"
      rpy="${link_params[link_name][link_config]['inertial']['origin']['r']}
           ${link_params[link_name][link_config]['inertial']['origin']['p']}
           ${link_params[link_name][link_config]['inertial']['origin']['y']}" />
      <mass value="${link_params[link_name][link_config]['inertial']['mass']}" />
      <inertia 
      ixx="${link_params[link_name][link_config]['inertial']['inertia']['ixx']}"
      ixy="${link_params[link_name][link_config]['inertial']['inertia']['ixy']}"
      ixz="${link_params[link_name][link_config]['inertial']['inertia']['ixz']}"
      iyy="${link_params[link_name][link_config]['inertial']['inertia']['iyy']}"
      iyz="${link_params[link_name][link_config]['inertial']['inertia']['iyz']}"
      izz="${link_params[link_name][link_config]['inertial']['inertia']['izz']}"  />
  </inertial>
</xacro:macro>

<xacro:macro name="setup_visual" params="link_name link_config">
  <visual>
    <geometry>
      <mesh filename="package://${robot_config}_description/meshes/${link_params[link_name][link_config]['visual']['mesh']}"/>
    </geometry>
    <origin 
    xyz="${link_params[link_name][link_config]['visual']['origin']['x']}
         ${link_params[link_name][link_config]['visual']['origin']['y']}
         ${link_params[link_name][link_config]['visual']['origin']['z']}"
    rpy="${link_params[link_name][link_config]['visual']['origin']['r']}
         ${link_params[link_name][link_config]['visual']['origin']['p']}
         ${link_params[link_name][link_config]['visual']['origin']['y']}" />
    <material name="black"/>
  </visual>
</xacro:macro>

<xacro:macro name="setup_collision" params="link_name link_config">
    <collision>
      <geometry>
        <mesh filename="package://${robot_config}_description/meshes/${link_params[link_name][link_config]['collision']['mesh']}"/>
      </geometry>
      <origin 
      xyz="${link_params[link_name][link_config]['collision']['origin']['x']}
           ${link_params[link_name][link_config]['collision']['origin']['y']}
           ${link_params[link_name][link_config]['collision']['origin']['z']}"
      rpy="${link_params[link_name][link_config]['collision']['origin']['r']}
           ${link_params[link_name][link_config]['collision']['origin']['p']}
           ${link_params[link_name][link_config]['collision']['origin']['y']}"/>
    </collision>
</xacro:macro>

<xacro:macro name="calc_joint" params="prefix child parent" >

<!-- Collect DH parameters for link angles and lengths -->
  <xacro:property name="joint_params_name" value="${prefix}_${child}_joint_parameters" />
  <xacro:property name="link_params_name" value="${prefix}_${child}_link_parameters" />
  <xacro:property name="theta" value="${robot_params[link_params_name]['theta']}" />
  <xacro:property name="r" value="${robot_params[link_params_name]['r']}" />

  <xacro:property name="parent_params_name" value="${prefix}_${parent}_link_parameters" />
  <xacro:property name="parent_theta" value="${robot_params[parent_params_name]['theta']}" />
  <xacro:property name="parent_r" value="${robot_params[parent_params_name]['r']}" />
  <xacro:property name="parent_alpha" value="${robot_params[parent_params_name]['alpha']}" />

  <xacro:unless value="${child == 'foot'}" >
    <limit effort = "100.0" lower="${robot_params[joint_params_name]['min']}" upper="${robot_params[joint_params_name]['max']}" velocity="5"/>
    <child link="${prefix}_${child}_link"/>
  </xacro:unless>

  <xacro:if value="${parent == 'base'}">
    <parent link="${parent}_link"/>
  </xacro:if>
  <xacro:unless value="${parent == 'base'}">
    <parent link="${prefix}_${parent}_link"/>
  </xacro:unless>

<!-- Hacky work around for model not matching DH parameters -->
<!-- TODO: clean this up -->
  <xacro:if value="${child == 'coxa'}">
    <axis xyz = "0 1 0"/>
    <origin rpy="1.5708 0 ${parent_theta+theta}" 
            xyz="${cos(parent_theta)*parent_r} ${sin(parent_theta)*parent_r} 0.0527"/>
  </xacro:if>

  <xacro:if value="${child == 'femur'}">
    <axis xyz = "0 0 1"/>
    <origin rpy="0 0 0" xyz="0 0.0393 0"/>  
  </xacro:if>

  <xacro:if value="${child == 'foot'}">
    <axis xyz = "0 0 1"/>
    <origin rpy="0 0 0" xyz="${parent_r-0.031} 0 0"/>  
  </xacro:if>

  <xacro:unless value="${(child == 'coxa') or (child == 'femur') or (child == 'foot')}">
    <axis xyz = "0 0 1"/>
    <origin rpy="${parent_alpha} 0 ${parent_theta}" xyz="${parent_r} 0 0"/>  
  </xacro:unless>

</xacro:macro>

<xacro:macro  name="make_link" params="prefix name config parent" >
  <link name="${prefix}_${name}_link">
    <xacro:setup_inertia link_name="${name}" link_config="${config}" />
    <xacro:setup_visual link_name="${name}" link_config="${config}" />
    <xacro:setup_collision link_name="${name}" link_config="${config}" />
  </link>
  <joint name="${prefix}_${name}_joint" type="revolute">
    <xacro:calc_joint prefix="${prefix}" child="${name}" parent="${parent}" />
  </joint>
</xacro:macro>

  <!-- MACRO USED TO SETUP THE LINKS AND JOINTS OF THE LEGS-->
<xacro:macro name="init_leg" params="prefix coxa_config:=default femur_config:=default tibia_config:=default">

  <xacro:make_link prefix="${prefix}" name="coxa" config="${coxa_config}" parent="base" />

  <xacro:make_link prefix="${prefix}" name="femur" config="${femur_config}" parent="coxa" />

  <xacro:make_link prefix="${prefix}" name="tibia" config="${tibia_config}" parent="femur" />

  <link name="${prefix}_foot_link_1">
    <inertial>
      <origin
        xyz="0.02E-03 2.88E-03 -4.39E-03" rpy="0 0 0" />
      <mass value="0.03591" />
      <inertia ixx="60131.00E-09" ixy="610.47E-09" ixz="387.97E-09" iyy="31108.13E-09" iyz="346.50E-09" izz="31112.38E-09" />
    </inertial>
  </link>
  <joint name="${prefix}_foot_joint_1" type="revolute">
    <xacro:calc_joint prefix="${prefix}" child="foot" parent="tibia" />
    <limit effort = "100.0" lower="-0.523599" upper="0.523599" velocity="5"/>
    <child link="${prefix}_foot_link_1"/>
    <dynamics damping="0.2" friction="0.0"/>
  </joint>


  <link name="${prefix}_foot_link_2">
    <inertial>
      <origin
        xyz="0.02E-03 2.88E-03 -4.39E-03"
        rpy="0 0 0" />
      <mass value="0.02961" />
      <inertia ixx="8786.61E-09" ixy="34.74E-09" ixz="7.47E-09" iyy="10893.41E-09" iyz="-95.83E-09" izz="17608.23E-09" />
    </inertial>
  </link>
  <joint name="${prefix}_foot_joint_2" type="revolute">
    <axis xyz = "0 1 0"/>
    <limit effort = "100.0" lower="-0.418879" upper="0.418879" velocity="5"/>
    <parent link="${prefix}_foot_link_1"/>
    <child link="${prefix}_foot_link_2"/>
    <origin rpy="0 0 0" xyz="0 0 0"/>
    <dynamics damping="0.2" friction="0.0"/>
  </joint>


  <link name="${prefix}_foot_link_3">
    <inertial>
      <origin
        xyz="0.02E-03 2.88E-03 -4.39E-03"
        rpy="0 0 0" />
      <mass value="0.32158" />
      <inertia ixx="49836.99E-09" ixy="144.66E-09" ixz="-4031.72E-09" iyy="81967.91E-09" iyz="-678.12E-09" izz="69129.32E-09" />
    </inertial>
  </link>
  <joint name="${prefix}_foot_joint_3" type="revolute">
    <axis xyz = "1 0 0"/>
    <limit effort = "100.0" lower="-2.07694" upper="2.07694" velocity="5"/>
    <parent link="${prefix}_foot_link_2"/>
    <child link="${prefix}_foot_link_3"/>
    <origin rpy="0 0 0" xyz="0 0 0"/>
    <dynamics damping="0.2" friction="0.0"/>
  </joint>
<!-- 
  <link name="${prefix}_foot_link">
      <geometry>
        <mesh filename="package://magneto_2_description/meshes/foot_link.STL"/>
      </geometry>
      <origin rpy="0 0 0" xyz="0 0 0"/>
      <material name="black"/>
    </visual>
  </link>
  <gazebo reference="${prefix}_foot_link">
    <selfCollide>false</selfCollide>
    <visual>
      <transparency>1</transparency>
    </visual>  
  </gazebo>
  <joint name="${prefix}_foot_joint" type="fixed">
    <child link="${prefix}_foot_link"/>
    <xacro:calc_joint prefix="${prefix}" child="foot" parent="tibia" />
  </joint> -->

</xacro:macro> 

<!-- Initialise each leg -->
<xacro:init_leg prefix="AR" tibia_config="ft_sensor"/>
<xacro:init_leg prefix="BR" tibia_config="default"/>
<xacro:init_leg prefix="BL" tibia_config="default"/>
<xacro:init_leg prefix="AL" tibia_config="default"/>
</robot>