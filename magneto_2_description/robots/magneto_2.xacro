<?xml version="1.0"?>
<robot xmlns:xacro="http://www.ros.org/wiki/xacro" name="magneto">

<!-- Name of robot used to find config and description files -->
<xacro:property name="robot_config" value="magneto_2" />

<!-- Load robot configuration parameters from YAML file -->
<xacro:property name="robot_params_filename" value="$(find ${robot_config}_description)/config/${robot_config}.yaml" />
<xacro:property name="robot_params" value="${load_yaml(robot_params_filename)['syropod']['parameters']}"/>

<!-- Load link configuration parameters from YAML file -->
<xacro:property name="link_params_filename" value="$(find ${robot_config}_description)/config/${robot_config}_link_configs.yaml" />
<xacro:property name="link_params" value="${load_yaml(link_params_filename)[robot_config]}"/>

<!-- To view robot and manually manipluate joints in rviz, run:
     "roslaunch magneto_syropod rviz_joint_control.launch model:=magneto_2-5"
     Create a urdf from this xacro by running "xacro magneto_2.xacro > magneto_2.urdf" 
     in a terminal in the magneto_2_description/robots directory -->

  <!-- Set colour of Magneto body and links. For list of gazebo materials/colours, see:
       https://bitbucket.org/osrf/gazebo/src/a1fb370811b64723827c4e40fa3867ccbd8fd584/media/materials/scripts/gazebo.material?fileviewer=file-view-default  -->   
  <xacro:property name="body_colour" value="DarkGrey" />

  <!-- Setup material colours for viewing in RViz -->
  <material name="white"><color rgba="1 1 1 1"/></material>
  <material name="green"><color rgba="0 1 0 1"/></material>
  <material name="black"><color rgba="0.15 0.15 0.15 1"/></material>

  <!-- ADD FORCE TO SIMULATE MAGNETS  -->
  <gazebo>
    <plugin name="model_push_plugin" filename="libmodel_push_plugin.so">
      <adhesionForce>500</adhesionForce>
    </plugin>
  </gazebo>

  <!-- SETUP CONTROL FOR TRANSMISSIONS/JOINT MOVEMENTS-->
  <gazebo>
    <plugin name="gazebo_ros_control" filename="libgazebo_ros_control.so">
      <robotNamespace>/syropod</robotNamespace>
    </plugin>
  </gazebo>

  <!-- SETUP MAIN BASE LINK -->
  <link name="root_link"></link> <!-- Work around for base_link not being allowed to have intertial properties in robot_state_publisher -->
  <link name="base_link">
    <inertial>
      <origin rpy="0 0 0" xyz="-0.2696E-03 0 33.3181E-03"/>
      <mass value="1.44521"/>
      <inertia ixx="0.0083421056972" ixy="-4.932e-08" ixz="-2.47500871e-05" iyy="0.0136724752281" iyz="2.37e-11" izz="0.0180888568473"/>
    </inertial>
    <visual>
      <geometry>
        <mesh filename="package://magneto_2_description/meshes/base_link.STL"/>
      </geometry>
      <origin rpy="0 0 0" xyz="0 0 0"/>
      <material name="black"/>
    </visual>
    <collision>
      <geometry>
        <mesh filename="package://magneto_2_description/meshes/base_link_collision.STL"/>
      </geometry>
      <origin rpy="0 0 0" xyz="0 0 0"/>
    </collision>
  </link>
  <gazebo reference="base_link">
    <selfCollide>true</selfCollide>
    <material>Gazebo/${body_colour}</material>
    <mu1>999999999999999999999999999999999999999</mu1>
    <mu2>999999999999999999999999999999999999999</mu2>
    <kp>1000000.0</kp>
    <kd>100.0</kd>
  </gazebo>
  <joint name="_base_joint" type="fixed">
    <axis xyz="0 0 0"/>
    <limit effort="100" lower="0" upper="0" velocity="5"/>
    <parent link="root_link"/>
    <child link="base_link"/>
    <origin rpy="0 0 0" xyz="0 0 0"/>
  </joint>
  
  <!-- SETUP IMU SENSOR  -->
  <gazebo reference="base_link">
    <gravity>true</gravity>
    <sensor name="imu_sensor" type="imu">
      <always_on>true</always_on>
      <update_rate>100</update_rate>
      <visualize>true</visualize>
      <topic>__default_topic__</topic>
      <plugin name="imu_plugin" filename="libimu_plugin.so">
        <topicName>magneto/imu/data</topicName>
        <bodyName>base_link</bodyName>
        <updateRateHZ>10.0</updateRateHZ>
        <gaussianNoise>0.0</gaussianNoise>
        <xyzOffset>0 0 0</xyzOffset>
        <rpyOffset>0 0 0</rpyOffset>
        <frameName>base_link</frameName>
      </plugin>
      <pose>0 0 0 0 0 0</pose>
    </sensor>
  </gazebo>

  <!-- SETUP BODY MOUNTED DEPTH SENSOR -->
  <link name="body_depth_sensor_link">
    <inertial>
      <origin rpy="0 0 0" xyz="-0.0128746 0 -0.0101382"/>
      <mass value="0.16024"/>
      <inertia ixx="0.00014178" ixy="0" ixz="2.537E-05" iyy="0.00013367" iyz="0" izz="9.987E-05"/>
    </inertial>
    <visual>
      <geometry>
        <mesh filename="package://magneto_2_description/meshes/pico_monstar.STL"/>
      </geometry>
      <origin rpy="0 0 0" xyz="0 0 0"/>
      <material name="black"/>
    </visual>
    <collision>
      <geometry>
        <box size="0.029 0.062 0.066"/>
      </geometry>
      <origin rpy="0 0 0" xyz="-0.009 0 -0.011"/>
    </collision>
  </link>

  <joint name="body_depth_sensor_joint" type="fixed">
    <origin xyz="0.157 0 0.096" rpy="0 0.3491 0"/>   
    <parent link="base_link"/>
    <child link="body_depth_sensor_link"/>
  </joint>

  <joint name="body_depth_sensor_optical_joint" type="fixed">
    <origin xyz="0 0 0" rpy="-1.5708 0 -1.5708"/>    
    <parent link="body_depth_sensor_link"/>
    <child link="body_optical_frame"/>
  </joint>

  <link name="body_optical_frame">
  </link>
  
  <gazebo reference="body_depth_sensor_link">
    <selfCollide>true</selfCollide>
    <material>Gazebo/${body_colour}</material>
    <sensor name="pico_flexx_body" type="depth">
        <update_rate>20</update_rate>
        <camera>
          <horizontal_fov>1.745329</horizontal_fov>
          <image>
            <width>352</width>
            <height>287</height>
            <format>R8G8B8</format>
          </image>
          <clip>
            <near>0.001</near>
            <far>6</far>
          </clip>
        </camera>
        <plugin name="kinect" filename="libgazebo_ros_openni_kinect.so">
          <baseline>0.2</baseline>
          <alwaysOn>true</alwaysOn>
          <!-- Keep this zero, update_rate in the parent <sensor> tag
            will control the frame rate. -->
          <updateRate>0.0</updateRate>
          <cameraName>camera_ir_body</cameraName>
          <imageTopicName>/pico_flexx_body/color/image_raw</imageTopicName>
          <cameraInfoTopicName>/pico_flexx_body/color/camera_info</cameraInfoTopicName>
          <depthImageTopicName>/pico_flexx_body/depth/image_raw</depthImageTopicName>
          <depthImageCameraInfoTopicName>/pico_flexx_body/depth/camera_info</depthImageCameraInfoTopicName>
          <pointCloudTopicName>/pico_flexx_body/points</pointCloudTopicName>
          <frameName>body_optical_frame</frameName>
          <pointCloudCutoff>0.001</pointCloudCutoff>
          <pointCloudCutoffMax>6</pointCloudCutoffMax>
          <distortionK1>0</distortionK1>
          <distortionK2>0</distortionK2>
          <distortionK3>0</distortionK3>
          <distortionT1>0</distortionT1>
          <distortionT2>0</distortionT2>
          <CxPrime>0</CxPrime>
          <Cx>0</Cx>
          <Cy>0</Cy>
          <focalLength>0</focalLength>
          <hackBaseline>0</hackBaseline>
        </plugin>
      </sensor>
  </gazebo> 

  <!-- SETUP FRONT INDICATOR TO SHOW WHICH WAY MAGNETO IS FACING -->
  <link name="front_indicator">
    <visual>
      <geometry>
        <cylinder length="0.001" radius="0.005"/>
      </geometry>
      <material name="green"/>
    </visual>
  </link>
  <gazebo reference="front_indicator">
    <material>Gazebo/Green</material>
  </gazebo>
  <joint name="front_link_joint" type="fixed">
    <parent link="base_link"/>
    <child link="front_indicator"/>
    <origin rpy="0 0 0" xyz="0.080 0 0.095"/>
  </joint>

<xacro:macro name="setup_inertia" params="link_name link_config">
  <inertial>
      <origin 
      xyz="${link_params[link_name][link_config]['inertial']['origin']['x']}
           ${link_params[link_name][link_config]['inertial']['origin']['y']}
           ${link_params[link_name][link_config]['inertial']['origin']['z']}"
      rpy="${link_params[link_name][link_config]['inertial']['origin']['r']}
           ${link_params[link_name][link_config]['inertial']['origin']['p']}
           ${link_params[link_name][link_config]['inertial']['origin']['y']}" />
      <mass value="${link_params[link_name][link_config]['inertial']['mass']}" />
      <inertia 
      ixx="${link_params[link_name][link_config]['inertial']['inertia']['ixx']}"
      ixy="${link_params[link_name][link_config]['inertial']['inertia']['ixy']}"
      ixz="${link_params[link_name][link_config]['inertial']['inertia']['ixz']}"
      iyy="${link_params[link_name][link_config]['inertial']['inertia']['iyy']}"
      iyz="${link_params[link_name][link_config]['inertial']['inertia']['iyz']}"
      izz="${link_params[link_name][link_config]['inertial']['inertia']['izz']}"  />
  </inertial>
</xacro:macro>

<xacro:macro name="setup_visual" params="link_name link_config">
  <visual>
    <geometry>
      <mesh filename="package://${robot_config}_description/meshes/${link_params[link_name][link_config]['visual']['mesh']}"/>
    </geometry>
    <origin 
    xyz="${link_params[link_name][link_config]['visual']['origin']['x']}
         ${link_params[link_name][link_config]['visual']['origin']['y']}
         ${link_params[link_name][link_config]['visual']['origin']['z']}"
    rpy="${link_params[link_name][link_config]['visual']['origin']['r']}
         ${link_params[link_name][link_config]['visual']['origin']['p']}
         ${link_params[link_name][link_config]['visual']['origin']['y']}" />
    <material name="black"/>
  </visual>
</xacro:macro>

<xacro:macro name="setup_collision" params="link_name link_config">
    <collision>
      <geometry>
        <mesh filename="package://${robot_config}_description/meshes/${link_params[link_name][link_config]['collision']['mesh']}"/>
      </geometry>
      <origin 
      xyz="${link_params[link_name][link_config]['collision']['origin']['x']}
           ${link_params[link_name][link_config]['collision']['origin']['y']}
           ${link_params[link_name][link_config]['collision']['origin']['z']}"
      rpy="${link_params[link_name][link_config]['collision']['origin']['r']}
           ${link_params[link_name][link_config]['collision']['origin']['p']}
           ${link_params[link_name][link_config]['collision']['origin']['y']}"/>
    </collision>
</xacro:macro>

<xacro:macro name="calc_joint" params="prefix child parent" >

<!-- Collect DH parameters for link angles and lengths -->
  <xacro:property name="joint_params_name" value="${prefix}_${child}_joint_parameters" />
  <xacro:property name="link_params_name" value="${prefix}_${child}_link_parameters" />
  <xacro:property name="theta" value="${robot_params[link_params_name]['theta']}" />
  <xacro:property name="r" value="${robot_params[link_params_name]['r']}" />

  <xacro:property name="parent_params_name" value="${prefix}_${parent}_link_parameters" />
  <xacro:property name="parent_theta" value="${robot_params[parent_params_name]['theta']}" />
  <xacro:property name="parent_r" value="${robot_params[parent_params_name]['r']}" />
  <xacro:property name="parent_alpha" value="${robot_params[parent_params_name]['alpha']}" />

  <xacro:unless value="${child == 'foot'}" >
    <limit effort = "100.0" lower="${robot_params[joint_params_name]['min']}" upper="${robot_params[joint_params_name]['max']}" velocity="5"/>
    <child link="${prefix}_${child}_link"/>
  </xacro:unless>

  <xacro:if value="${parent == 'base'}">
    <parent link="${parent}_link"/>
  </xacro:if>
  <xacro:unless value="${parent == 'base'}">
    <parent link="${prefix}_${parent}_link"/>
  </xacro:unless>

<!-- Hacky work around for model not matching DH parameters -->
<!-- TODO: clean this up -->
  <xacro:if value="${child == 'coxa'}">
    <axis xyz = "0 1 0"/>
    <origin rpy="1.5708 0 ${parent_theta+theta}" 
            xyz="${cos(parent_theta)*parent_r} ${sin(parent_theta)*parent_r} 0.052"/>
  </xacro:if>

  <xacro:if value="${child == 'femur'}">
    <axis xyz = "0 0 1"/>
    <origin rpy="0 0 0" xyz="0 0.035 0"/>  
  </xacro:if>

  <xacro:if value="${child == 'foot'}">
    <axis xyz = "0 0 1"/>
    <origin rpy="0 0 0" xyz="${parent_r-0.031} 0 0"/>  
  </xacro:if>

  <xacro:unless value="${(child == 'coxa') or (child == 'femur') or (child == 'foot')}">
    <axis xyz = "0 0 1"/>
    <origin rpy="${parent_alpha} 0 ${parent_theta}" xyz="${parent_r} 0 0"/>  
  </xacro:unless>

</xacro:macro>

<xacro:macro  name="make_link" params="prefix name config parent" >
  <link name="${prefix}_${name}_link">
    <xacro:setup_inertia link_name="${name}" link_config="${config}" />
    <xacro:setup_visual link_name="${name}" link_config="${config}" />
    <xacro:setup_collision link_name="${name}" link_config="${config}" />
  </link>
  <gazebo reference="${prefix}_${name}_link">
    <selfCollide>true</selfCollide>
    <material>Gazebo/${body_colour}</material>
  </gazebo>
  <joint name="${prefix}_${name}_joint" type="revolute">
    <xacro:calc_joint prefix="${prefix}" child="${name}" parent="${parent}" />
  </joint>
</xacro:macro>

  <!-- MACRO USED TO SETUP THE LINKS AND JOINTS OF THE LEGS-->
<xacro:macro name="init_leg" params="prefix coxa_config:=default femur_config:=default tibia_config:=default">

  <xacro:make_link prefix="${prefix}" name="coxa" config="${coxa_config}" parent="base" />

  <xacro:make_link prefix="${prefix}" name="femur" config="${femur_config}" parent="coxa" />

  <xacro:make_link prefix="${prefix}" name="tibia" config="${tibia_config}" parent="femur" />

  <link name="${prefix}_ft_link">
    <inertial>
      <origin xyz="5.11E-03 -0.03E-03 1.24E-03" rpy="0 0 0"/>
      <mass value="0.145"/>
      <inertia ixx="59155.92E-09"  ixy="-126.37E-09"  ixz="-793.01E-09" iyy="65718.77E-09" iyz="29.91E-09" izz="43619.83E-09" />
    </inertial>

    <!-- <visual>
      <origin xyz="-0.03 0 0" rpy="0 0 0" />
      <geometry>
        <box size="0.06 0.01 0.01" />
      </geometry>
      <material name="black"/>
    </visual> -->

    <!-- <collision>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <cylinder radius="1" length="0.5"/>
      </geometry>
    </collision> -->
  </link>

  <joint name="${prefix}_ft_joint" type="fixed">
    <parent link="${prefix}_tibia_link"/>
    <child link="${prefix}_ft_link"/>
    <origin rpy="0 0 0" xyz="0.072 0 0"/>
  </joint>

  <gazebo reference="${prefix}_ft_joint">
    <selfCollide>false</selfCollide>
    <material>Gazebo/${body_colour}</material>
    <preserveFixedJoint>true</preserveFixedJoint>
  </gazebo>

  <!-- Enable the Joint Feedback -->
  <!-- New Plugin -->
  <gazebo reference="${prefix}_ft_joint">
    <provideFeedback>true</provideFeedback>
  </gazebo>
  <gazebo>
    <plugin name="${prefix}_ft_sensor" filename="libgazebo_ros_ft_sensor.so">
      <updateRate>200.0</updateRate>
      <topicName>/forceTorque/${prefix}</topicName>
      <jointName>${prefix}_ft_joint</jointName>
      <noise>
        <type>gaussian</type>
        <mean>0.0</mean>
        <stddev>0.0</stddev>
      </noise>
    </plugin>
  </gazebo>
  
  <!-- Old Plugin -->
  <!-- <gazebo reference="${prefix}_ft_joint">
    <provideFeedback>true</provideFeedback>
  </gazebo>
  <gazebo>
    <plugin name="${prefix}_ft_sensor" filename="libft_plugin.so">
      <updateRate>200.0</updateRate>
      <topicName>/forceTorque/${prefix}</topicName>
      <jointName>${prefix}_ft_joint</jointName>
      <pose>0 0 0 0 0 0</pose>
    </plugin>
  </gazebo> -->

  <link name="${prefix}_ft_frame">
    <!-- <inertial>
      <origin xyz="5.11E-03 -0.03E-03 1.24E-03" rpy="0 0 0"/>
      <mass value="0.145"/>
      <inertia ixx="59155.92E-09"  ixy="-126.37E-09"  ixz="-793.01E-09" iyy="65718.77E-09" iyz="29.91E-09" izz="43619.83E-09" />
    </inertial> -->
  </link>

  <joint name="${prefix}_ft_frame_joint" type="fixed">
    <parent link="${prefix}_ft_link"/>
    <child link="${prefix}_ft_frame"/>
    <origin rpy="1.571 0 -1.571" xyz="0 0 0"/>
  </joint>



  <link name="${prefix}_foot_link_1">
    <inertial>
      <origin
        xyz="0.08E-03 2.94E-03 -4.05E-03" rpy="0 0 0" />
      <mass value="0.03552" />
      <inertia ixx="59323.24E-09" ixy="615.24E-09" ixz="321.99E-09" iyy="30637.66E-09" iyz="346.39E-09" izz="30638.04E-09" />
    </inertial>
    <visual>
      <geometry>
        <mesh filename="package://magneto_2_description/meshes/foot_link_1.STL"/>
      </geometry>
      <origin rpy="0 0 0" xyz="0 0 0"/>
      <material name="black"/>
    </visual>
    <collision>
      <geometry>
        <mesh filename="package://magneto_2_description/meshes/foot_link_1_collision.STL"/>
      </geometry>
      <origin rpy="0 0 0" xyz="0 0 0"/>
    </collision>
  </link>
  <gazebo reference="${prefix}_foot_link_1">
    <selfCollide>false</selfCollide>
    <material>Gazebo/${body_colour}</material>
    <kp>1000000.0</kp>
    <kd>100.0</kd>
  </gazebo>

  <joint name="${prefix}_foot_joint_1" type="revolute">
    <axis xyz = "0 0 1"/>
    <parent link="${prefix}_ft_link"/>
    <child link="${prefix}_foot_link_1"/>
    <origin rpy="0 0 0" xyz="0.059 0 0"/>
    <!-- <xacro:calc_joint prefix="${prefix}" child="foot" parent="tibia" /> -->
    <limit effort = "100.0" lower="-0.523599" upper="0.523599" velocity="5"/>
    <child link="${prefix}_foot_link_1"/>
    <dynamics damping="0.2" friction="0.0"/>
  </joint>

  <gazebo reference="${prefix}_foot_joint_1">
    <implicitSpringDamper>true</implicitSpringDamper>
    <springStiffness>0.5</springStiffness>
    <springReference>0</springReference>
  </gazebo>

  <link name="${prefix}_foot_link_2">
    <inertial>
      <origin
        xyz="0.02E-03 2.88E-03 -4.39E-03"
        rpy="0 0 0" />
      <mass value="0.02961" />
      <inertia
        ixx="8786.61E-09"
        ixy="34.74E-09"
        ixz="7.47E-09"
        iyy="10893.41E-09"
        iyz="-95.83E-09"
        izz="17608.23E-09" />
    </inertial>
    <visual>
      <geometry>
        <mesh filename="package://magneto_2_description/meshes/foot_link_2.STL"/>
      </geometry>
      <origin rpy="0 0 0" xyz="0 0 0"/>
      <material name="black"/>
    </visual>
    <collision>
      <geometry>
        <mesh filename="package://magneto_2_description/meshes/foot_link_2_collision.STL"/>
      </geometry>
      <origin rpy="0 0 0" xyz="0 0 0"/>
    </collision>
  </link>
  <gazebo reference="${prefix}_foot_link_2">
    <selfCollide>false</selfCollide>
    <material>Gazebo/${body_colour}</material>
    <kp>1000000.0</kp>
    <kd>100.0</kd>
  </gazebo>
  
  <joint name="${prefix}_foot_joint_2" type="revolute">
    <axis xyz = "0 1 0"/>
    <limit effort = "100.0" lower="-0.418879" upper="0.418879" velocity="5"/>
    <parent link="${prefix}_foot_link_1"/>
    <child link="${prefix}_foot_link_2"/>
    <origin rpy="0 0 0" xyz="0 0 0"/>
    <dynamics damping="0.2" friction="0.0"/>
  </joint>

  <gazebo reference="${prefix}_foot_joint_2">
    <implicitSpringDamper>true</implicitSpringDamper>
    <springStiffness>0.5</springStiffness>
    <springReference>0</springReference>
  </gazebo>

  <link name="${prefix}_foot_link_3">
    <inertial>
      <origin
        xyz="0.02E-03 2.88E-03 -4.39E-03"
        rpy="0 0 0" />
      <mass value="0.32158" />
      <inertia
        ixx="49836.99E-09"
        ixy="144.66E-09"
        ixz="-4031.72E-09"
        iyy="81967.91E-09"
        iyz="-678.12E-09"
        izz="69129.32E-09" />
    </inertial>
    <visual>
      <geometry>
        <mesh filename="package://magneto_2_description/meshes/foot_link_3.STL"/>
      </geometry>
      <origin rpy="0 0 0" xyz="0 0 0"/>
      <material name="black"/>
    </visual>
    <collision>
      <geometry>
        <mesh filename="package://magneto_2_description/meshes/foot_link_3_collision.STL"/>
      </geometry>
      <origin rpy="0 0 0" xyz="0 0 0"/>
    </collision>
  </link>
  <gazebo reference="${prefix}_foot_link_3">
    <selfCollide>false</selfCollide>
    <material>Gazebo/${body_colour}</material>
    <visual>
      <plugin name="color_change" filename="libcolor_change_plugin.so">
        <control_topic>${prefix}</control_topic>
      </plugin>  
    </visual>
    <kp>1000000.0</kp>
    <kd>100.0</kd>
    <mu1>999999999999999999999999999999999999999</mu1>
    <mu2>999999999999999999999999999999999999999</mu2>

    <sensor name="${prefix}_magnet_contact_sensor" type="contact">
      <always_on>true</always_on>
      <update_rate>30.0</update_rate>
    <contact>
      <collision>${prefix}_foot_link_3_collision</collision>
    </contact>
    <plugin name="contact_plugin" filename="libcontact_plugin.so">
      <bumperTopicName>${prefix}_proximity_sense</bumperTopicName>
      <frameName>${prefix}_foot_link_3</frameName>
    </plugin>
  </sensor>
  </gazebo>
  
  <joint name="${prefix}_foot_joint_3" type="revolute">
    <axis xyz = "1 0 0"/>
    <limit effort = "100.0" lower="-2.07694" upper="2.07694" velocity="5"/>
    <parent link="${prefix}_foot_link_2"/>
    <child link="${prefix}_foot_link_3"/>
    <origin rpy="0 0 0" xyz="0 0 0"/>
    <dynamics damping="0.2" friction="0.0"/>
  </joint>

  <gazebo reference="${prefix}_foot_joint_3">
    <implicitSpringDamper>true</implicitSpringDamper>
    <springStiffness>0.5</springStiffness>
    <springReference>0</springReference>
  </gazebo>

  <link name="${prefix}_foot_link">
    <visual>
      <geometry>
        <mesh filename="package://magneto_2_description/meshes/foot_link.STL"/>
      </geometry>
      <origin rpy="0 0 0" xyz="0 0 0"/>
      <material name="black"/>
    </visual>
  </link>
  <gazebo reference="${prefix}_foot_link">
    <selfCollide>false</selfCollide>
    <visual>
      <transparency>1</transparency>
    </visual>  
  </gazebo>
  <joint name="${prefix}_foot_joint" type="fixed">
    <parent link="${prefix}_ft_link"/>
    <child link="${prefix}_foot_link"/>
    <origin rpy="0 0 0" xyz="0.059 0 0"/>
  </joint>

  <!-- SETUP DEPTH SENSORS (pico flexx) -->
  <link name="${prefix}_depth_sensor_link">
    <visual>
      <geometry>
        <mesh filename="package://magneto_2_description/meshes/depth_sensor.STL"/>
      </geometry>
      <origin rpy="0 0 0" xyz="0 0 0"/>
      <material name="black"/>
    </visual>
    <collision>
      <geometry>
        <box size="0.02 0.025 0.08"/>
      </geometry>
      <origin rpy="0 0 0" xyz="0 0.002 0.01"/>
    </collision>
  </link>

  <joint name="${prefix}_depth_sensor_joint" type="fixed">
    <origin xyz="0.01544 0.05678 0.000" rpy="0 0 0.5672"/>   
    <parent link="${prefix}_tibia_link"/>
    <child link="${prefix}_depth_sensor_link"/>
  </joint>

  <joint name="${prefix}_depth_sensor_optical_joint" type="fixed">
    <origin xyz="0 0 0" rpy="-1.5708 0 -1.5708"/>    
    <parent link="${prefix}_depth_sensor_link"/>
    <child link="gazebo_${prefix}_leg_optical_frame"/>
  </joint>

  <link name="gazebo_${prefix}_leg_optical_frame">
  </link>
  
  <gazebo reference="${prefix}_depth_sensor_link">
    <selfCollide>true</selfCollide>
    <material>Gazebo/${body_colour}</material>
    <sensor name="pico_flexx_${prefix}_leg" type="depth">
        <update_rate>20</update_rate>
        <camera>
          <horizontal_fov>1.082104</horizontal_fov>
          <image>
            <width>224</width>
            <height>171</height>
            <format>R8G8B8</format>
          </image>
          <clip>
            <near>0.001</near>
            <far>4</far>
          </clip>
        </camera>
        <plugin name="kinect" filename="libgazebo_ros_openni_kinect.so">
          <baseline>0.2</baseline>
          <alwaysOn>true</alwaysOn>
          <!-- Keep this zero, update_rate in the parent <sensor> tag
            will control the frame rate. -->
          <updateRate>0.0</updateRate>
          <cameraName>camera_ir_${prefix}</cameraName>
          <imageTopicName>/pico_flexx_${prefix}_leg/color/image_raw</imageTopicName>
          <cameraInfoTopicName>/pico_flexx_${prefix}_leg/color/camera_info</cameraInfoTopicName>
          <depthImageTopicName>/pico_flexx_${prefix}_leg/depth/image_raw</depthImageTopicName>
          <depthImageCameraInfoTopicName>/pico_flexx_${prefix}_leg/depth/camera_info</depthImageCameraInfoTopicName>
          <pointCloudTopicName>/pico_flexx_${prefix}_leg/points</pointCloudTopicName>
          <frameName>gazebo_${prefix}_leg_optical_frame</frameName>
          <pointCloudCutoff>0.001</pointCloudCutoff>
          <pointCloudCutoffMax>4.0</pointCloudCutoffMax>
          <distortionK1>0</distortionK1>
          <distortionK2>0</distortionK2>
          <distortionK3>0</distortionK3>
          <distortionT1>0</distortionT1>
          <distortionT2>0</distortionT2>
          <CxPrime>0</CxPrime>
          <Cx>0</Cx>
          <Cy>0</Cy>
          <focalLength>0</focalLength>
          <hackBaseline>0</hackBaseline>
        </plugin>
      </sensor>
  </gazebo> 
  <!-- Setup transmissions for joints -->
  <transmission name="${prefix}_coxa_tran">
    <type>transmission_interface/SimpleTransmission</type>
      <joint name="${prefix}_coxa_joint">
        <hardwareInterface>hardware_interface/EffortJointInterface</hardwareInterface>
      </joint>
      <actuator name="${prefix}_coxa_motor">
        <hardwareInterface>hardware_interface/EffortJointInterface</hardwareInterface>
            <mechanicalReduction>1</mechanicalReduction>
      </actuator>
  </transmission>
  <transmission name="${prefix}_femur_tran">
    <type>transmission_interface/SimpleTransmission</type>
      <joint name="${prefix}_femur_joint">
        <hardwareInterface>hardware_interface/EffortJointInterface</hardwareInterface>
      </joint>
      <actuator name="${prefix}_femur_motor">
        <hardwareInterface>hardware_interface/EffortJointInterface</hardwareInterface>
            <mechanicalReduction>1</mechanicalReduction>
      </actuator>
  </transmission>
  <transmission name="${prefix}_tibia_tran">
    <type>transmission_interface/SimpleTransmission</type>
      <joint name="${prefix}_tibia_joint">
        <hardwareInterface>hardware_interface/EffortJointInterface</hardwareInterface>
      </joint>
      <actuator name="${prefix}_tibia_motor">
        <hardwareInterface>hardware_interface/EffortJointInterface</hardwareInterface>
            <mechanicalReduction>1</mechanicalReduction>
      </actuator>
  </transmission>

  <!-- SETUP IMU FOR EACH FOOT -->
  <!-- <link name="${prefix}_IMU_link">
    <visual>
      <geometry>
        <box size="0.01 0.01 0.01"/>
      </geometry>
      <origin rpy="0 0 0" xyz="0 0 0"/>
      <material name="black"/>
    </visual>
  </link>
  <joint name="${prefix}_IMU_joint" type="fixed">
    <origin xyz="-0.02 0 0.02" rpy="0 0 0"/>    
    <parent link="${prefix}_foot_link"/>
    <child link="${prefix}_IMU_link"/>
  </joint>

  <gazebo reference="${prefix}_IMU_link">
    <selfCollide>false</selfCollide>
    <material>Gazebo/SkyBlue</material>
    <gravity>true</gravity>
    <sensor name="${prefix}_imu_sensor" type="imu">
      <always_on>true</always_on>
      <update_rate>100</update_rate>
      <visualize>true</visualize>
      <topic>__default_topic__</topic>
      <plugin name="imu_plugin" filename="libimu_plugin.so">
        <topicName>magneto/${prefix}_imu/data</topicName>
        <bodyName>${prefix}_IMU_link</bodyName>
        <updateRateHZ>100</updateRateHZ>
        <gaussianNoise>0.0</gaussianNoise>
        <xyzOffset>0 0 0</xyzOffset>
        <rpyOffset>0 0 0</rpyOffset>
        <frameName>${prefix}_IMU_link</frameName>
      </plugin>
      <pose>0 0 0 0 0 0</pose>
    </sensor>
  </gazebo> -->
</xacro:macro> 

<!-- Initialise each leg -->
<xacro:init_leg prefix="AR" tibia_config="ft_sensor"/>
<xacro:init_leg prefix="BR" tibia_config="ft_sensor"/>
<xacro:init_leg prefix="BL" tibia_config="ft_sensor"/>
<xacro:init_leg prefix="AL" tibia_config="ft_sensor"/>
</robot>